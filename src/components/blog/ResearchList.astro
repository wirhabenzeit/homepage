---
import { getCollection } from "astro:content";
import FancyPostPreview from "./FancyPostPreview.astro";
import type { CollectionEntry } from "astro:content";
import PublicationDetails from "../PublicationDetails.astro";
import Tags from "./Tags.astro";

interface Props {
	numbered?: boolean;
	large?: boolean;
	filter?: (post: CollectionEntry<"research">) => boolean;
	reversable?: boolean;
}

const { numbered = false, large = false, filter = () => true } = Astro.props;

const heros = await Astro.glob("/src/content/research/*/hero.astro");

const heroMapping = heros.reduce((acc, hero) => {
	const match = hero.file.match(/research\/(.+)\/hero\.astro/);
	if (match) {
		const id = `${match[1]}/index.mdx`;
		acc[id] = hero;
	}
	return acc;
}, {});

const allPosts = ((await getCollection("research", filter)) as CollectionEntry<"research">[])
	.sort((a, b) => -b.data.publishDate.getTime() + a.data.publishDate.getTime())
	.map((post) => ({ ...post, ...(post.id in heroMapping && { hero: heroMapping[post.id] }) }));

var isRight = [] as boolean[];

for (let post of allPosts) {
	isRight.push(
		post.data.heroImage || post.Hero
			? !isRight[isRight.length - 1]
			: isRight[isRight.length - 1] || false,
	);
}
---

<ol class="not-prose flex flex-col-reverse gap-8" id="research-list">
	{
		allPosts.map((post, i) => (
			<li class="flex flex-auto flex-col flex-wrap gap-2 sm:flex-row [&_q]:basis-full">
				<FancyPostPreview
					{...("hero" in post ? { Hero: post.hero } : {})}
					right={isRight[i]}
					{...(post.data.heroImageHover
						? { heroImage: post.data.heroImageHover }
						: post.data.heroImage
							? { heroImage: post.data.heroImage }
							: {})}
					large={large}
					url={`${import.meta.env.BASE_URL}research/${post.slug}`}
				>
					<div slot="title">
						<h2 class="mb-1 text-xl font-bold">
							{numbered && `${i + 1}. `}
							<a href={`${import.meta.env.BASE_URL}research/${post.slug}`} class="text-accent">
								{post.data.title}
							</a>
						</h2>
						<PublicationDetails {...post.data} />
					</div>
					<p class="text-md" slot="description">
						{post.data.description}
					</p>
					<Tags tags={post.data.tags} slot="tags" />
				</FancyPostPreview>
			</li>
		))
	}
</ol>

<!-- <script is:inline>
	const reverseButtonListener = () => {
		const button = document.querySelector("#reverse");
		const list = document.querySelector("#research-list");
		const arrowIcon = document.querySelector("#arrow-icon");

		button.addEventListener("change", () => {
			list.classList.toggle("flex-col-reverse");
			list.classList.toggle("flex-col");
			arrowIcon.classList.toggle("rotate-180");
		});
	};

	["DOMContentLoaded", "astro:after-swap"].forEach((event) => {
		document.addEventListener(event, reverseButtonListener);
	});
</script> -->
